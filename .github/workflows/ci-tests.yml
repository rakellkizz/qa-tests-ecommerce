name: QA Pipeline - E2E + Integration + Performance

on:
  push:
    branches: [ "main", "perf/*", "docs/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # (1) Instala SÓ o que é necessário para os testes de integração
      - name: Instalar deps (tests-integration)
        run: npm ci
        working-directory: ./projetos/tests-integration

      # (2) Roda os testes de integração (usa o jest local da pasta)
      - name: Testes de Integração (Jest)
        run: npx jest -c jest.config.js --runInBand --reporters=default --reporters=jest-junit
        working-directory: ./projetos/tests-integration

      # (3) Garante o relatório JUnit
      - name: Garantir relatório JUnit
        if: success() || failure()
        run: test -f junit.xml && echo "JUnit ok" || echo "Sem junit.xml"
        working-directory: ./projetos/tests-integration

      # (4) Testes de Performance (K6) via Docker
      - name: Testes de Performance (K6)
        run: |
          docker run --rm -i \
            -v "${{ github.workspace }}/projetos/tests-performance-k6:/scripts" \
            -w /scripts \
            -e K6_BASE_URL="https://httpbin.test.k6.io" \
            grafana/k6 run load_test.js

      # (5) Publica artefatos
      - name: Upload de Relatórios
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            projetos/tests-integration/junit.xml
            projetos/tests-performance-k6/results/
