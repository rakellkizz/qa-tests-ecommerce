name: QA Pipeline - E2E + Integration + Performance

on:
  push:
    branches: [ "main", "perf/*", "docs/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # (1) Instala SÓ o que é necessário para os testes de integração
      - name: Instalar deps (tests-integration)
        run: npm ci
        working-directory: ./projetos/tests-integration

      # (2) Roda os testes de integração (usa o jest local da pasta)
      - name: Testes de Integração (Jest)
        run: npx jest -c jest.config.js --runInBand --reporters=default --reporters=jest-junit
        working-directory: ./projetos/tests-integration

      # (3) Garante o relatório JUnit
      - name: Garantir relatório JUnit
        if: success() || failure()
        run: test -f junit.xml && echo "JUnit ok" || echo "Sem junit.xml"
        working-directory: ./projetos/tests-integration

      # (4) Testes de Performance (K6) via Docker
      - name: Testes de Performance (K6)
        run: |
          docker run --rm -i \
            -v "${{ github.workspace }}/projetos/tests-performance-k6:/scripts" \
            -w /scripts \
            -e K6_BASE_URL="https://httpbin.test.k6.io" \
            grafana/k6 run load_test.js

      # (5) Publica artefatos
      - name: Upload de Relatórios
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            projetos/tests-integration/junit.xml
            projetos/tests-performance-k6/results/
  e2e:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Instalar deps do projeto raiz
        run: npm ci

      - name: Subir servidor local (8080)
        run: |
          npx http-server ./local_site -p 8080 -a 0.0.0.0 &
          npx wait-on http://127.0.0.1:8080

      - name: Rodar Cypress (headless)
        uses: cypress-io/github-action@v6
        with:
          install: false
          browser: chrome
        env:
          CYPRESS_baseUrl: http://127.0.0.1:8080

      - name: Upload de screenshots (se houver)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore

      - name: Upload de vídeos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: ignore
  mutation:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Instalar deps (tests-integration)
        run: npm ci
        working-directory: ./projetos/tests-integration

      - name: Rodar Mutation Testing (Stryker)
        run: npm run test:mutation
        working-directory: ./projetos/tests-integration

      - name: Upload relatório de mutação
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: projetos/tests-integration/reports/mutation/
